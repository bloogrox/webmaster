<!--


пользователь первый раз вошел
он попадает на авторизацию
далее он попадает в отчет

нужно выбрать хост
отчет: за последние дни позиции популярных запросов
делаем несколько запросов за статистикой

стата есть только за завершенные дни
если сегодня 24 число, то стата имеется только до 22

получение данных для хоста
- пользователь инициирует нажатием кнопки
- система смотрит каких дней нет за последние 90 дат
- по отсутствующим дням загружает
- сохраняет в local storage

показ отчета
- по строкам у нас запрос
- по столбцам даты
- берем самый свежий день отсортированный по позиции


хранилище
[
    {date: xx-xx-xxxx, queries: []}
    ... or
    {date: xx-xx-xxxx, query: "aaaaa", avg_position_size: 8}
    {date: xx-xx-xxxx, query: "bbbbb", avg_position_size: 5}
    ... or
]


 -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Webmaster</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@3.5.1/dist/full.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com/3.3.1"></script>
    <style>
        * {font-family: sans-serif;}
    </style>
    <script src="https://yastatic.net/s3/passport-sdk/autofill/v1/sdk-suggest-with-polyfills-latest.js"></script>
</head>
<body>
    <div id="app" class="max-w-screen-lg m-auto">
        <div class="navbar bg-base-100">
            <div class="navbar-start">
                <router-link to="/" class="btn btn-ghost normal-case tex
t-xl">Home</router-link>
            </div>
            <!-- <div class="navbar-center hidden lg:flex">
            <ul class="menu menu-horizontal px-1">
                <li><router-link to="/journal" :class="{'active': $route
.path == '/journal'}">Дневник</router-link></li>
                <li><router-link to="/beliefs" :class="{'active': $route
.path == '/beliefs'}">Убеждения</router-link></li>
                <li><router-link to="/practice" :class="{'active': $rout
e.path == '/practice'}">Проработка</router-link></li>
            </ul>
            </div> -->
            <div class="navbar-end">
                <!-- <router-link to="/setup" class="rounded-xl text-sm px-4 py-1 border border-gray-300 hover:bg-gray-100">настройки</router-link> -->

                <!-- <ul class="menu menu-horizontal px-1">
                    <li tabindex="0">
                        <details>
                            <summary>{{ projectName }}</summary>
                            <ul class="p-2">
                                <li v-for="project in projects">
                                    <a :href="'?project=' + project">{{
project }}</a>
                                </li>
                            </ul>
                        </details>
                    </li>
                </ul> -->
            </div>
        </div>
        <router-view></router-view>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/vue@3.3.4/dist/vue.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue-router@4.2.1/dist/vue-router.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue-demi@0.14.5/lib/index.iife.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pinia@2.1.3/dist/pinia.iife.min.js"></script>
    <!-- <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script> -->

    <script type="module">
        const { createRouter, createWebHistory, createWebHashHistory } = VueRouter
        import { createORM, Model, useRepo, mapRepos, Repository } from 'https://cdn.jsdelivr.net/npm/pinia-orm@1.6.7/+esm';
        import createPersistPlugin from 'https://bloogrox.github.io/pinia-local-storage-plugin/index.js';


        // const formatDateMixin = {
        //     methods: {
        //         formatDate(dateString) {
        //             const date = dayjs(dateString);
        //             return date.format('DD-MM-YYYY');
        //         }
        //     }
        // }


        /*** Project */
        function getProjectName() {
            let urlParams = new URLSearchParams(window.location.search);
            return urlParams.has("project") ? urlParams.get("project") : "default";
        }


        /*** Pinia */
        const pinia = Pinia.createPinia();

        pinia.use(createPersistPlugin({bucket: getProjectName()}));


        /*** ORM Init **/
        const orm_config = {
            model: {
                withMeta: true,
                hidden: [],
                visible: ['*']
            }
        }
        pinia.use(createORM(orm_config));


        /***************************************************
         *
         * ORM Models
         *
         * */

        // class Outcome extends Model {

        //     static entity = 'outcomes'

        //     static hidden = []

        //     static fields () {
        //         return {
        //             id: this.uid(),
        //             title: this.string(''),

        //             // thoughts: this.hasMany(Thought, 'problem_id').onDelete('cascade'),
        //         }
        //     }
        // }

        class StatsRepo extends Repository {

            use = Stats

            getNewestDate() {
                return {queries: []}  // .orderBy('date', 'desc').first()
            }

            getSearchQueries(){
                return this.getNewestDate().queries.toSorted(x => x.indicators.AVG_SHOW_POSITION)
            }

            getDates() {
                return []  // .orderBy('date', 'desc')
            }

        }

        /***************************************************
         *
         * Components
         *
         */

        const Home = {
            data() {
                return {
                    token: ''
                }
            },
            computed: {
                search_queries() {
                    return []
                    // return useRepo(StatsRepo, pinia).getSearchQueries()  // get most recent date, get queries
                },
                dates() {
                    return []
                    // return useRepo(StatsRepo, pinia).getDates()
                },
            },
            methods: {
                getUserId() {
                    const api = new YandexWebmasterStub(this.token)
                    const user_id = api.getUserId()
                        .then( resp => resp.json() )
                        .then( data => {
                            console.log(data.user_id)
                        })
                }
            },
            template: `
                <div>
                    <!--input type="text" v-model="token" class="input input-bordered w-full"-->
                    <!--div class="mt-5">
                        <button @click="getUserId" class="btn">click</button>
                    </div-->
                    <!--div class="mt-10">
                        <table>
                            <tr v-for="search_query in search_queries">
                                <td>search query.text</td>
                                <td v-for="date in dates">
                                    date.queries.filter(x)
                                </td>
                            </tr>
                        </table>
                    </div-->
                    <div class="mt-10">
                        <div class="">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Запросы (3)</th>
                                        <th>Частота</th>
                                        <th class="w-10">11.09.2023</th>
                                        <th class="w-10">12.09.2023</th>
                                        <th class="w-10">13.09.2023</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Щебень</td>
                                        <td>390</td>
                                        <td>1</td>
                                        <td>1</td>
                                        <td>1</td>
                                    </tr>
                                    <tr>
                                        <td>Песок</td>
                                        <td>--</td>
                                        <td>2</td>
                                        <td>2</td>
                                        <td>2</td>
                                    </tr>
                                    <tr>
                                        <td>Купить</td>
                                        <td>--</td>
                                        <td>3</td>
                                        <td>3</td>
                                        <td>3</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `
        }

        /***************************************************
         *
         * Ext
         *
         */
        class YandexWebmaster {

            api_url = 'https://api.webmaster.yandex.net/v4/'

            constructor(token) {
                this.token = token
            }

            getUserId() {
                const url = this.api_url + 'user'
                const options = {
                    headers: {
                        Authentication: 'OAuth ' + this.token
                    }
                }
                return fetch(url, options)
            }
        }


        class YandexWebmasterStub {

            getUserId() {
                const data = {
                    user_id: 9793111
                }

                return new Promise((resolve) => { resolve(Response.json(data)) })
            }

            getHosts() {
                const data = {
                    "hosts": [
                        {
                            "host_id": "https:eleganty.ru:443",
                            "ascii_host_url": "https://eleganty.ru/",
                            "unicode_host_url": "https://eleganty.ru/",
                            "verified": true,
                            "main_mirror": null
                        },
                        {
                            "host_id": "http:eleganty.ru:80",
                            "ascii_host_url": "http://eleganty.ru/",
                            "unicode_host_url": "http://eleganty.ru/",
                            "verified": true,
                            "main_mirror": null
                        },
                        {
                            "host_id": "http:unilook.ru:80",
                            "ascii_host_url": "http://unilook.ru/",
                            "unicode_host_url": "http://unilook.ru/",
                            "verified": true,
                            "main_mirror": null
                        }
                    ]
                }

                return new Promise((resolve) => { resolve(Response.json(data)) })
            }

            getPopularQueries() {
                const data = {
                    "count": 101,
                    "date_from": "2023-09-20",
                    "date_to": "2023-09-20",
                    "queries": [
                        {
                            "query_id": "ecec0d42afb22f45",
                            "query_text": "цвет волос 2017 модные",
                            "indicators": {
                                "AVG_SHOW_POSITION": 8.0
                            }
                        },
                        {
                            "query_id": "82dec103cd0c7d34",
                            "query_text": "пыльник женский летний",
                            "indicators": {
                                "AVG_SHOW_POSITION": 30.0
                            }
                        }
                    ]
                }

                return new Promise((resolve) => { resolve(Response.json(data)) })
            }

        }

        /***************************************************
         *
         * Router
         *
         **/
         const router = createRouter({
            history: createWebHashHistory(),
            routes: [
                { path: '/', component: Home },
            ],
        });


        const rootComp = {
            computed: {
                // ...Pinia.mapWritableState(pStore, [
                //     'script'
                // ]),
                projectName() {
                    return getProjectName()
                },
                projects() {
                    return Object.keys(localStorage).filter(x => x != this.projectName)
                }
            },
            mounted() {
                // console.log('hello')
                // const hosts = api.getHosts()
                // console.log(hosts)
                // const report = api.getPopularQueries()
                // console.log(hosts)
            }
        }


        const app = Vue.createApp(rootComp);
        app.use(pinia);
        app.use(router);
        app.mount("#app");

    </script>
    <script>
        // window.YaAuthSuggest.init(
        //     {
        //         client_id: 'ccba5862126b4b2aba1261e5dfd5165d',
        //         response_type: 'token',
        //         redirect_uri: 'https://bloogrox.github.io/webmaster/auth.html'
        //     },
        //     'https://bloogrox.github.io',
        //     {
        //         view: "button",
        //         parentId: "buttonContainerId",
        //         buttonSize: 'm',
        //         buttonView: 'icon',
        //         buttonTheme: 'light',
        //         buttonBorderRadius: "0",
        //         buttonIcon: 'ya',
        //     }
        // )
        // .then(({handler}) => handler())
        // .then(data => console.log('Сообщение с токеном', data))
        // .catch(error => console.log('Обработка ошибки', error))
    </script>
</body>
</html>